!function(a,b,c){function d(a){if(!a.bucket_domain)throw"必须指定 bucket_domain!";if(!a.browse_button)throw"必须指定 browse_button!";var d={trim:function(a){return null===a?"":this.trim.call(a)},parse_json:function(a){return window.JSON&&window.JSON.parse?window.JSON.parse(a):null===a?a:"string"==typeof a&&(a=this.trim(a),a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return a}():void 0},create_ajax:function(){var a={};return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},utf8_encode:function(a){if(null===a||"undefined"==typeof a)return"";var b,c,d=a+"",e="",f=0;b=c=0,f=d.length;for(var g=0;f>g;g++){var h=d.charCodeAt(g),i=null;if(128>h)c++;else if(h>127&&2048>h)i=String.fromCharCode(h>>6|192,63&h|128);else if(63488&h^!0)i=String.fromCharCode(h>>12|224,h>>6&63|128,63&h|128);else{if(64512&h^!0)throw new RangeError("Unmatched trail surrogate at "+g);var j=d.charCodeAt(++g);if(64512&j^!0)throw new RangeError("Unmatched lead surrogate at "+(g-1));h=((1023&h)<<10)+(1023&j)+65536,i=String.fromCharCode(h>>18|240,h>>12&63|128,h>>6&63|128,63&h|128)}null!==i&&(c>b&&(e+=d.slice(b,c)),e+=i,b=c=g+1)}return c>b&&(e+=d.slice(b,f)),e},base64_encode:function(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;a=this.utf8_encode(a+"");do b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),i=b<<16|c<<8|d,e=i>>18&63,f=i>>12&63,g=i>>6&63,h=63&i,n[l++]=j.charAt(e)+j.charAt(f)+j.charAt(g)+j.charAt(h);while(k<a.length);switch(m=n.join(""),a.length%3){case 1:m=m.slice(0,-2)+"==";break;case 2:m=m.slice(0,-1)+"="}return m},url_safe_base64_encode:function(a){return a=this.base64_encode(a),a.replace(/\//g,"_").replace(/\+/g,"-")}},e={MAX_CHUNK_SIZE:4<<20,HTTPS_UP_HOST:"https://up.qbox.me",HTTP_UP_HOST:"http://up.qiniu.com"},f=this,g={},h=a.uptoken_url,i="",j=a.bucket_domain,k="",l="",m="",n=function(){return"object"==typeof a.init&&"function"==typeof a.init.Key?a.init.Key:null}(),o=function(){return"object"==typeof a.init&&"function"==typeof a.init.FileUploaded?a.init.FileUploaded:function(){}}(),p=function(){if(a.up_host)return a.up_host;var b=window.location.protocol;return"https"!==b?e.HTTP_UP_HOST:e.HTTPS_UP_HOST},q=function(){var d,f="IE"===c.Env.browser&&c.Env.version<=9;f&&a.chunk_size&&a.runtimes.indexOf("flash")>=0?a.chunk_size=0:(d=b.parseSize(a.chunk_size),d>e.MAX_CHUNK_SIZE&&(a.chunk_size=e.MAX_CHUNK_SIZE))},r=function(){"object"==typeof a.init&&(a.init.FileUploaded=null)},s=function(){if(a.uptoken)i=a.uptoken;else{var b=d.create_ajax();b.open("GET",h,!0),b.setRequestHeader("If-Modified-Since","0"),b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var a=d.parse_json(b.responseText);i=a.uptoken}},b.send()}},t=function(a,b){var c=a.getOption&&a.getOption(b);return c=c||a.settings&&a.settings[b]},u=function(b,d,e){var f="",g=!1;if(!a.save_key)if(g=t(b,"unique_names")){var h=c.Mime.getFileExtension(d.name);f=h?d.id+"."+h:d.id}else f="function"==typeof e?e(b,d):d.name;return f};this.get_url=function(a){return a?(a=encodeURI(a),"/"!==j.slice(j.length-1)&&(j+="/"),j+a):!1},this.version="2.0.0-beta";var v=function(){l=p(),q(),r(),b.extend(g,a,{url:l,multipart_params:{token:""}})};return v(),m=new b.Uploader(g),m.bind("Init",function(){s()}),m.init(),m.bind("FilesAdded",function(a,b){var c=t(a,"auto_start");c&&$.each(b,function(){a.start()}),a.refresh()}),m.bind("BeforeUpload",function(b,c){k="";var d=function(b,c,d){var e;e=a.save_key?{token:i}:{key:u(b,c,d),token:i};var f=a.x_vars;if(void 0!==f&&"object"==typeof f)for(var g in f)f.hasOwnProperty(g)&&("function"==typeof f[g]?e["x:"+g]=f[g](b,c):"object"!=typeof f[g]&&(e["x:"+g]=f[g]));b.setOption({url:l,multipart:!0,chunk_size:void 0,multipart_params:e})},e=function(a,b){var c=localStorage.getItem(b.name),d=f;if(c){c=JSON.parse(c);var e=(new Date).getTime(),g=c.time||0,h=864e5;h>e-g&&100!==c.percent?(b.percent=c.percent,b.loaded=c.offset,k=c.ctx,c.offset+d>b.size&&(d=b.size-c.offset)):localStorage.removeItem(b.name)}a.setOption({url:l+"/mkblk/"+d,multipart:!1,chunk_size:f,required_features:"chunks",headers:{Authorization:"UpToken "+i},multipart_params:{}})},f=t(b,"chunk_size");"html5"===m.runtime&&f?c.size<f?d(b,c,n):e(b,c):d(b,c,n)}),m.bind("ChunkUploaded",function(a,b,c){var e=function(a){localStorage.setItem(a.name,JSON.stringify({ctx:k,percent:a.percent,total:c.total,offset:c.offset,time:(new Date).getTime()}))},f=d.parse_json(c.response);k=k?k+","+f.ctx:f.ctx;var g=c.total-c.offset,h=t(a,"chunk_size");h>g&&a.setOption({url:l+"/mkblk/"+g}),e(b)}),m.bind("Error",function(a,c){var e="",f=c.file;if(f){switch(c.code){case b.FAILED:e="上传失败。请稍后再试。";break;case b.FILE_SIZE_ERROR:var g=t(a,"max_file_size");e="浏览器最大可上传"+g+"。更大文件请使用命令行工具。";break;case b.FILE_EXTENSION_ERROR:e="文件验证失败。请稍后重试。";break;case b.HTTP_ERROR:var h=d.parse_json(c.response),i=h.error;switch(c.status){case 400:e="请求报文格式错误。";break;case 401:e="客户端认证授权失败。请重试或提交反馈。";break;case 405:e="客户端请求错误。请重试或提交反馈。";break;case 579:e="资源上传成功，但回调失败。";break;case 599:e="网络连接异常。请重试或提交反馈。";break;case 614:e="文件已存在。";try{h=d.parse_json(h.error),i=h.error||"file exists"}catch(j){i=h.error||"file exists"}break;case 631:e="指定空间不存在。";break;case 701:e="上传数据块校验出错。请重试或提交反馈。";break;default:e="未知错误。"}e=e+"("+c.status+"："+i+")";break;case b.SECURITY_ERROR:e="安全配置错误。请联系网站管理员。";break;case b.GENERIC_ERROR:e="上传失败。请稍后再试。";break;case b.IO_ERROR:e="上传失败。请稍后再试。";break;case b.INIT_ERROR:e="网站配置错误。请联系网站管理员。",m.destroy();break;default:e=c.message+c.details}a.setOption("error",e)}a.refresh()}),m.bind("FileUploaded",function(c,e,g){var h=function(b){var f="";a.save_key||(f=u(c,e,n),f=f?"/key/"+d.url_safe_base64_encode(f):"");var g=j(),h=l+"/mkfile/"+e.size+f+g,o=d.create_ajax();o.open("POST",h,!0),o.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),o.setRequestHeader("Authorization","UpToken "+i),o.onreadystatechange=function(){if(4===o.readyState)if(localStorage.removeItem(e.name),200===o.status){var a=o.responseText;p(b,a)}else m.trigger("Error",{status:o.status,response:o.responseText,file:e,code:-200})},o.send(k)},j=function(){var b=a.x_vars,f="",g="";if(void 0!==b&&"object"==typeof b)for(var h in b)b.hasOwnProperty(h)&&("function"==typeof b[h]?f=d.url_safe_base64_encode(b[h](c,e)):"object"!=typeof b[h]&&(f=d.url_safe_base64_encode(b[h])),g+="/x:"+h+"/"+f);return g},p=function(f,g){if(a.downtoken_url){var h=d.parse_json(g),i=d.create_ajax();i.open("POST",a.downtoken_url,!1),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status){var a;try{a=d.parse_json(i.responseText)}catch(f){throw"服务端返回了无效 JSON"}b.extend(h,a),g=JSON.stringify(h),o(c,e,g)}else m.trigger("Error",{status:i.status,response:i.responseText,file:e,code:b.HTTP_ERROR})},i.send("key="+h.key+"&bucket_domain="+a.bucket_domain)}else g=d.parse_json(g),o(c,e,g)},q=d.parse_json(g.response);k=k?k:q.ctx,k?h(f):p(f,g.response)}),m}if("object"!=typeof dependencies)throw"七牛 JS-SDK 依赖 Plupload 插件,请引入! 抄送门： http://plupload.com/download";a.Qiniu=d}(window,plupload,mOxie);