!function(a,b){function c(a){if(!a.bucket_domain)throw"必须指定 bucket_domain!";if(!a.browse_button)throw"必须指定 browse_button!";var b={trim:function(a){return null===a?"":this.trim.call(a)},parseJSON:function(a){return window.JSON&&window.JSON.parse?window.JSON.parse(a):null===a?a:"string"==typeof a&&(a=this.trim(a),a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return a}():void 0},createAjax:function(){var a={};return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},utf8_encode:function(a){if(null===a||"undefined"==typeof a)return"";var b,c,d=a+"",e="",f=0;b=c=0,f=d.length;for(var g=0;f>g;g++){var h=d.charCodeAt(g),i=null;if(128>h)c++;else if(h>127&&2048>h)i=String.fromCharCode(h>>6|192,63&h|128);else if(63488&h^!0)i=String.fromCharCode(h>>12|224,h>>6&63|128,63&h|128);else{if(64512&h^!0)throw new RangeError("Unmatched trail surrogate at "+g);var j=d.charCodeAt(++g);if(64512&j^!0)throw new RangeError("Unmatched lead surrogate at "+(g-1));h=((1023&h)<<10)+(1023&j)+65536,i=String.fromCharCode(h>>18|240,h>>12&63|128,h>>6&63|128,63&h|128)}null!==i&&(c>b&&(e+=d.slice(b,c)),e+=i,b=c=g+1)}return c>b&&(e+=d.slice(b,f)),e},base64_encode:function(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;a=this.utf8_encode(a+"");do b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),i=b<<16|c<<8|d,e=i>>18&63,f=i>>12&63,g=i>>6&63,h=63&i,n[l++]=j.charAt(e)+j.charAt(f)+j.charAt(g)+j.charAt(h);while(k<a.length);switch(m=n.join(""),a.length%3){case 1:m=m.slice(0,-2)+"==";break;case 2:m=m.slice(0,-1)+"="}return m},url_safe_base64_encode:function(a){return a=this.base64_encode(a),a.replace(/\//g,"_").replace(/\+/g,"-")}},c={MAX_CHUNK_SIZE:4<<20,HTTPS_UP_HOST:"https://up.qbox.me",HTTP_UP_HOST:"http://up.qiniu.com"},d=this,e={},f=a.uptoken_url,g="",h=(a.bucket_domain,""),i="",j="",k=function(){return"object"==typeof a.init&&"function"==typeof a.init.Key?a.init.Key:null}(),l=function(){return"object"==typeof a.init&&"function"==typeof a.init.FileUploaded?a.init.FileUploaded:function(){}}(),m=function(){if(a.up_host)return a.up_host;var b=window.location.protocol;return"https"!==b?c.HTTP_UP_HOST:c.HTTPS_UP_HOST},n=function(){var b,d="IE"===mOxie.Env.browser&&mOxie.Env.version<=9;d&&a.chunk_size&&a.runtimes.indexOf("flash")>=0?a.chunk_size=0:(b=plupload.parseSize(a.chunk_size),b>c.MAX_CHUNK_SIZE&&(a.chunk_size=c.MAX_CHUNK_SIZE))},o=function(){"object"==typeof a.init&&(a.init.FileUploaded=null)},p=function(){if(a.uptoken)g=a.uptoken;else{var c=b.createAjax();c.open("GET",f,!0),c.setRequestHeader("If-Modified-Since","0"),c.onreadystatechange=function(){if(4===c.readyState&&200===c.status){var a=b.parseJSON(c.responseText);g=a.uptoken}},c.send()}},q=function(a,b){var c=a.getOption&&a.getOption(b);return c=c||a.settings&&a.settings[b]},r=function(b,c,d){var e="",f=!1;if(!a.save_key)if(f=q(b,"unique_names")){var g=mOxie.Mime.getFileExtension(c.name);e=g?c.id+"."+g:c.id}else e="function"==typeof d?d(b,c):c.name;return e};this.getUrl=function(a){return a?(a=encodeURI(a),"/"!==bucket_domain.slice(bucket_domain.length-1)&&(bucket_domain+="/"),bucket_domain+a):!1};var s=function(){i=m(),n(),o(),plupload.extend(e,a,{url:i,multipart_params:{token:""}})};return s(),j=new plupload.Uploader(e),j.bind("Init",function(){p()}),j.init(),j.bind("FilesAdded",function(a,b){var c=q(a,"auto_start");c&&$.each(b,function(){a.start()}),a.refresh()}),j.bind("BeforeUpload",function(b,c){h="";var d=function(b,c,d){var e;e=a.save_key?{token:g}:{key:r(b,c,d),token:g};var f=a.x_vars;if(void 0!==f&&"object"==typeof f)for(var h in f)f.hasOwnProperty(h)&&("function"==typeof f[h]?e["x:"+h]=f[h](b,c):"object"!=typeof f[h]&&(e["x:"+h]=f[h]));b.setOption({url:i,multipart:!0,chunk_size:void 0,multipart_params:e})},e=function(a,b){var c=localStorage.getItem(b.name),d=f;if(c){c=JSON.parse(c);var e=(new Date).getTime(),j=c.time||0,k=864e5;k>e-j&&100!==c.percent?(b.percent=c.percent,b.loaded=c.offset,h=c.ctx,c.offset+d>b.size&&(d=b.size-c.offset)):localStorage.removeItem(b.name)}a.setOption({url:i+"/mkblk/"+d,multipart:!1,chunk_size:f,required_features:"chunks",headers:{Authorization:"UpToken "+g},multipart_params:{}})},f=q(b,"chunk_size");"html5"===j.runtime&&f?c.size<f?d(b,c,k):e(b,c):d(b,c,k)}),j.bind("ChunkUploaded",function(a,c,d){var e=function(a){localStorage.setItem(a.name,JSON.stringify({ctx:h,percent:a.percent,total:d.total,offset:d.offset,time:(new Date).getTime()}))},f=b.parseJSON(d.response);h=h?h+","+f.ctx:f.ctx;var g=d.total-d.offset,j=q(a,"chunk_size");j>g&&a.setOption({url:i+"/mkblk/"+g}),e(c)}),j.bind("Error",function(a,c){var d="",e=c.file;if(e){switch(c.code){case plupload.FAILED:d="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var f=q(a,"max_file_size");d="浏览器最大可上传"+f+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:d="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:var g=b.parseJSON(c.response),h=g.error;switch(c.status){case 400:d="请求报文格式错误。";break;case 401:d="客户端认证授权失败。请重试或提交反馈。";break;case 405:d="客户端请求错误。请重试或提交反馈。";break;case 579:d="资源上传成功，但回调失败。";break;case 599:d="网络连接异常。请重试或提交反馈。";break;case 614:d="文件已存在。";try{g=b.parseJSON(g.error),h=g.error||"file exists"}catch(i){h=g.error||"file exists"}break;case 631:d="指定空间不存在。";break;case 701:d="上传数据块校验出错。请重试或提交反馈。";break;default:d="未知错误。"}d=d+"("+c.status+"："+h+")";break;case plupload.SECURITY_ERROR:d="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:d="上传失败。请稍后再试。";break;case plupload.IO_ERROR:d="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:d="网站配置错误。请联系网站管理员。",j.destroy();break;default:d=c.message+c.details}a.setOption("error",d)}a.refresh()}),j.bind("FileUploaded",function(c,e,f){var m=function(d){var f="";a.save_key||(f=r(c,e,k),f=f?"/key/"+b.url_safe_base64_encode(f):"");var l=n(),m=i+"/mkfile/"+e.size+f+l,p=b.createAjax();p.open("POST",m,!0),p.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),p.setRequestHeader("Authorization","UpToken "+g),p.onreadystatechange=function(){if(4===p.readyState)if(localStorage.removeItem(e.name),200===p.status){var a=p.responseText;o(d,a)}else j.trigger("Error",{status:p.status,response:p.responseText,file:e,code:-200})},p.send(h)},n=function(){var d=a.x_vars,f="",g="";if(void 0!==d&&"object"==typeof d)for(var h in d)d.hasOwnProperty(h)&&("function"==typeof d[h]?f=b.url_safe_base64_encode(d[h](c,e)):"object"!=typeof d[h]&&(f=b.url_safe_base64_encode(d[h])),g+="/x:"+h+"/"+f);return g},o=function(d,f){if(a.downtoken_url){var g=b.parseJSON(f),h=b.createAjax();h.open("POST",a.downtoken_url,!1),h.setRequestHeader("Content-type","application/x-www-form-urlencoded"),h.onreadystatechange=function(){if(4===h.readyState)if(200===h.status){var a;try{a=b.parseJSON(h.responseText)}catch(d){throw"服务端返回了无效 JSON"}plupload.extend(g,a),f=JSON.stringify(g),l(c,e,f)}else j.trigger("Error",{status:h.status,response:h.responseText,file:e,code:plupload.HTTP_ERROR})},h.send("key="+g.key+"&domain="+a.domain)}else f=b.parseJSON(f),l(c,e,f)},p=b.parseJSON(f.response);h=h?h:p.ctx,h?m(d):o(d,f.response)}),j}if("object"!=typeof b)throw"七牛 JS-SDK 依赖 Plupload 插件,请引入! 抄送门： http://plupload.com/download";a.Qiniu=c}(this,plupload);