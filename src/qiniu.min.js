!function(a,b,c){function d(a){var d,e,f,g,h,i={},j=this,k={MAX_CHUNK_SIZE:4<<20,HTTPS_UP_HOST:"https://up.qbox.me",HTTP_UP_HOST:"http://up.qiniu.com"};this.version="2.0.0-beta";var l=function(){if(!a.bucket_domain)throw"必须指定 bucket_domain!";if(!a.browse_button)throw"必须指定 browse_button!";if(!a.uptoken_url)throw"必须指定 uptoken_url"},m=function(){var b=function(){if(a.up_host)return a.up_host;var b=window.location.protocol;return"https"!==b?k.HTTP_UP_HOST:k.HTTPS_UP_HOST},c=function(){return"object"==typeof a.init&&"function"==typeof a.init.Key?a.init.Key:null},i=function(){return"object"==typeof a.init&&"function"==typeof a.init.FileUploaded?a.init.FileUploaded:function(){}};d=b(),f=a.uptoken_url,e=a.bucket_domain,g=c(),h=i()},n=function(){var d=function(){var d,e="IE"===c.Env.browser&&c.Env.version<=9;e&&a.chunk_size&&a.runtimes.indexOf("flash")>=0?a.chunk_size=0:(d=b.parseSize(a.chunk_size),d>k.MAX_CHUNK_SIZE&&(a.chunk_size=k.MAX_CHUNK_SIZE))},e=function(){"object"==typeof a.init&&(a.init.FileUploaded=function(){})};d(),e()};l(),m(),n(),this.util={parse_json:function(a){return window.JSON&&window.JSON.parse?window.JSON.parse(a):null===a?a:"string"==typeof a&&(a=c.trim(a),a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return a}():void 0},create_ajax:function(){var a={};return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},utf8_encode:function(a){if(null===a||"undefined"==typeof a)return"";var b,c,d=a+"",e="",f=0;b=c=0,f=d.length;for(var g=0;f>g;g++){var h=d.charCodeAt(g),i=null;if(128>h)c++;else if(h>127&&2048>h)i=String.fromCharCode(h>>6|192,63&h|128);else if(63488&h^!0)i=String.fromCharCode(h>>12|224,h>>6&63|128,63&h|128);else{if(64512&h^!0)throw new RangeError("Unmatched trail surrogate at "+g);var j=d.charCodeAt(++g);if(64512&j^!0)throw new RangeError("Unmatched lead surrogate at "+(g-1));h=((1023&h)<<10)+(1023&j)+65536,i=String.fromCharCode(h>>18|240,h>>12&63|128,h>>6&63|128,63&h|128)}null!==i&&(c>b&&(e+=d.slice(b,c)),e+=i,b=c=g+1)}return c>b&&(e+=d.slice(b,f)),e},base64_encode:function(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;a=this.utf8_encode(a+"");do b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),i=b<<16|c<<8|d,e=i>>18&63,f=i>>12&63,g=i>>6&63,h=63&i,n[l++]=j.charAt(e)+j.charAt(f)+j.charAt(g)+j.charAt(h);while(k<a.length);switch(m=n.join(""),a.length%3){case 1:m=m.slice(0,-2)+"==";break;case 2:m=m.slice(0,-1)+"="}return m},url_safe_base64_encode:function(a){return a=this.base64_encode(a),a.replace(/\//g,"_").replace(/\+/g,"-")},get_url:function(a){return a?(a=encodeURI(a),"/"!==e.slice(e.length-1)&&(e+="/"),e+a):!1}};var o=function(b,c){if(a.uptoken)i[b.id]=a.uptoken;else{var d=j.util.create_ajax();d.open("GET",f,!0),d.setRequestHeader("If-Modified-Since","0"),d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=j.util.parse_json(d.responseText);i[b.id]=a.uptoken,c()}},d.send()}},p=function(a,b){var c=a.getOption&&a.getOption(b);return c=c||a.settings&&a.settings[b]},q=function(b,d,e){var f="",g=!1;if(!a.save_key)if(g=p(b,"unique_names")){var h=c.Mime.getFileExtension(d.name);f=h?d.id+"."+h:d.id}else f="function"==typeof e?e(b,d):d.name;return f},r={},s="";b.extend(r,a,{url:d,multipart_params:{token:""}});var t=new b.Uploader(r);return t.bind("Init",function(){}),t.init(),t.bind("FilesAdded",function(a,c){var d=p(a,"auto_start");b.each(c,function(b){o(b,function(){d&&a.start()})}),a.refresh()}),t.bind("BeforeUpload",function(b,c){s="";var e=function(b,c,e){var f;f=a.save_key?{token:i[c.id]}:{key:q(b,c,e),token:i[c.id]};var g=a.x_vars;if(void 0!==g&&"object"==typeof g)for(var h in g)g.hasOwnProperty(h)&&("function"==typeof g[h]?f["x:"+h]=g[h](b,c):"object"!=typeof g[h]&&(f["x:"+h]=g[h]));b.setOption({url:d,multipart:!0,chunk_size:void 0,multipart_params:f})},f=function(a,b){var c=localStorage.getItem(b.name),e=h;if(c){c=JSON.parse(c);var f=(new Date).getTime(),g=c.time||0,j=864e5;j>f-g&&100!==c.percent?(b.percent=c.percent,b.loaded=c.offset,s=c.ctx,c.offset+e>b.size&&(e=b.size-c.offset)):localStorage.removeItem(b.name)}a.setOption({url:d+"/mkblk/"+e,multipart:!1,chunk_size:h,required_features:"chunks",headers:{Authorization:"UpToken "+i[b.id]},multipart_params:{}})},h=p(b,"chunk_size");"html5"===t.runtime&&h?c.size<h?e(b,c,g):f(b,c):e(b,c,g)}),t.bind("ChunkUploaded",function(a,b,c){var e=function(a){localStorage.setItem(a.name,JSON.stringify({ctx:s,percent:a.percent,total:c.total,offset:c.offset,time:(new Date).getTime()}))},f=j.util.parse_json(c.response);s=s?s+","+f.ctx:f.ctx;var g=c.total-c.offset,h=p(a,"chunk_size");h>g&&a.setOption({url:d+"/mkblk/"+g}),e(b)}),t.bind("Error",function(a,c){var d="",e=c.file;if(e){switch(c.code){case b.FAILED:d="上传失败。请稍后再试。";break;case b.FILE_SIZE_ERROR:var f=p(a,"max_file_size");d="浏览器最大可上传"+f+"。更大文件请使用命令行工具。";break;case b.FILE_EXTENSION_ERROR:d="文件验证失败。请稍后重试。";break;case b.HTTP_ERROR:var g=j.util.parse_json(c.response),h=g.error;switch(c.status){case 400:d="请求报文格式错误。";break;case 401:d="客户端认证授权失败。请重试或提交反馈。";break;case 405:d="客户端请求错误。请重试或提交反馈。";break;case 579:d="资源上传成功，但回调失败。";break;case 599:d="网络连接异常。请重试或提交反馈。";break;case 614:d="文件已存在。";try{g=j.util.parse_json(g.error),h=g.error||"file exists"}catch(i){h=g.error||"file exists"}break;case 631:d="指定空间不存在。";break;case 701:d="上传数据块校验出错。请重试或提交反馈。";break;default:d="未知错误。"}d=d+"("+c.status+"："+h+")";break;case b.SECURITY_ERROR:d="安全配置错误。请联系网站管理员。";break;case b.GENERIC_ERROR:d="上传失败。请稍后再试。";break;case b.IO_ERROR:d="上传失败。请稍后再试。";break;case b.INIT_ERROR:d="网站配置错误。请联系网站管理员。",t.destroy();break;default:d=c.message+c.details}a.setOption("error",d)}a.refresh()}),t.bind("FileUploaded",function(b,c,e){var f=function(){var e="";a.save_key||(e=q(b,c,g),e=e?"/key/"+j.util.url_safe_base64_encode(e):"");var f=k(),h=d+"/mkfile/"+c.size+e+f,m=j.util.create_ajax();m.open("POST",h,!0),m.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),m.setRequestHeader("Authorization","UpToken "+i[c.id]),m.onreadystatechange=function(){if(4===m.readyState)if(localStorage.removeItem(c.name),200===m.status){var a=m.responseText;l(a)}else t.trigger("Error",{status:m.status,response:m.responseText,file:c,code:-200})},m.send(s)},k=function(){var d=a.x_vars,e="",f="";if(void 0!==d&&"object"==typeof d)for(var g in d)d.hasOwnProperty(g)&&("function"==typeof d[g]?e=j.util.url_safe_base64_encode(d[g](b,c)):"object"!=typeof d[g]&&(e=j.util.url_safe_base64_encode(d[g])),f+="/x:"+g+"/"+e);return f},l=function(a){a=j.util.parse_json(a),h(b,c,a)},m=j.util.parse_json(e.response);s=s?s:m.ctx,s?f():l(e.response)}),t}if("object"!=typeof b||"object"!=typeof c)throw"七牛 JS-SDK 依赖 Plupload 插件,请引入! 抄送门： http://plupload.com/download";a.Qiniu=d}(window,plupload,mOxie);